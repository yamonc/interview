# 事务

[Mysql中事务ACID实现原理](https://www.cnblogs.com/rjzheng/p/10841031.html)

## 什么是数据库事务？

事务是一个不可分割的数据库操作序列，也是数据库并发控制的基本单位，其执行的结果必须使数据库从一种一致性状态变到另一种一致性状态。事务是逻辑上的一组操作，要么都执行，要么都不执行。

事务最经典也经常被拿出来说例子就是转账了。

假如小明要给小红转账1000元，这个转账会涉及到两个关键操作就是：将小明的余额减少1000元，将小红的余额增加1000元。万一在这两个操作之间突然出现错误比如银行系统崩溃，导致小明余额减少而小红的余额没有增加，这样就不对了。事务就是保证这两个关键操作要么都成功，要么都要失败。

## 什么是脏读？幻读？不可重复读？

- 脏读(Dirty Read):某个事务已经更新一份数据，另外一个事务在此时读取了这份数据，由于某些原因，前一个事务回滚了，则后一个事务所读取的数据就是不正确的。（当前事务可以查看到别的事务未提交的数据）
- 不可重复读(Non-repeatable read):在一个事务的两次查询中数据不一致，这可能是两次查询过程中插入了一个事务更新的原有数据。（在同一事务中，使用相同的查询语句，数据改变了）
- 幻读（Phantom Read):在一个事务中的两次查询中数据不一致。（在同一事务中，使用相同的查询语句，莫名出现了一些之前不存在的数据或者莫名少了一些原先存在的数据）

## SQL的隔离级别？

为了达到事务的四大特性，数据库定义了4种不同的事务隔离级别，由低到高依次为Read uncommitted、Read committed、Repeatable read、Serializable，这四个级别可以逐个解决脏读、不可重复读、幻读这几类问题。

读未提交：一个事务还没提交，就被另外的事务可以看到。可能会导致脏读、幻读或者不可重复读。

读已提交：一个事务提交后，他做的变更才能被别的事务看到。可以解决脏读，但是幻读或者不可重复读仍有可能发生。

可重复读： 一个事务执行过程中看到的数据总和事务启动时所看到的数据是一样的。在这个级别下，事务未提交，做出的变更其他事务不会看到。可以阻止脏读和不可重复读，但是幻读有可能发生。

串行化：对同一行记录进行读写会分别加读写锁，当发生读写锁冲突，后面执行的事务需要等前面执行的事务完成后才能执行。该级别可以防止脏读、不可重复读以及幻读。

这里需要注意的是：Mysql 默认采用的 REPEATABLE_READ隔离级别 Oracle 默认采用的 READ_COMMITTED隔离级别

事务隔离机制的实现基于锁机制和并发调度。其中并发调度使用的是MVVC（多版本并发控制），通过保存修改的旧版本信息来支持并发一致性读和回滚等特性。

因为隔离级别越低，事务请求的锁越少，所以大部分数据库系统的隔离级别都是READ-COMMITTED(读取提交内容):，但是你要知道的是InnoDB 存储引擎默认使用 **REPEATABLE-READ（可重读）**并不会有任何性能损失。

InnoDB 存储引擎在 分布式事务 的情况下一般会用到**SERIALIZABLE(可串行化)**隔离级别。

## 事务的原子性是怎么保证的？

使用mysql 的undo log，回滚日志，实现原子性的关键。当事务回滚的时候，能够撤销已经成功执行的sql语句，记录的是需要回滚的响应的日志信息。

比如：delete一条数据的时候，记录这条数据的信息，然后回滚的时候，insert这条旧数据。update的时候，记录之前的旧值，回滚的时候update旧值。insert一条数据的时候，需要记录这条记录的主键，然后回滚的时候，需要根据主键delete操作。

undo log记录了这些回滚需要的的信息，当事务执行失败的时候或者调用rollback的时候，导致事务回滚，可以利用undo log将数据回滚到修改之前的样子。

## MySQL的持久性是如何保持的？

利用redo log。MySQL首先是将磁盘上的数据加载到内存中，在内存中对数据进行修改，然后再刷回磁盘。如果此时突然down机，内存中的数据将会丢失。redo log包括两个部分：一是内存中的日志缓冲redo log buffer，该部分日志是易失去的；二是磁盘上的redo log file，改文件是持久的。InnoDB通过force log at commit机制实现事务的持久性。即在事务提交的时候，必须将该事务的所有日志写入到磁盘的redo log file和undo log file中进行持久化。

## 参考

[MySQL面试题2020](https://thinkwon.blog.csdn.net/article/details/104778621)

